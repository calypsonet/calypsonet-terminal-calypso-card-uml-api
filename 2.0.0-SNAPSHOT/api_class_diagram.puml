@startuml
title
    Calypsonet - calypsonet-terminal-calypso-java-api - 2.0.+ (2022-10-31)
end title

' == THEME ==

'Couleurs issues de : https://htmlcolorcodes.com/fr/tableau-de-couleur/tableau-de-couleur-design-plat/
!define C_GREY1 F8F9F9
!define C_GREY2 F2F3F4
!define C_GREY3 E5E7E9
!define C_GREY4 D7DBDD
!define C_GREY5 CACFD2
!define C_GREY6 BDC3C7
!define C_LINK 3498DB
!define C_USE 27AE60

' -- Styles that don't work with new version of plantuml --
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
' -- END --

skinparam ClassBorderThickness 2
skinparam ArrowThickness 2

' Yellow
skinparam ClassBackgroundColor #FEFECE
skinparam ClassBorderColor #D4AC0D
' Red
skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
' Purple
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
' blue
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
' Green
skinparam ClassBackgroundColor<<green>> #E9F7EF
skinparam ClassBorderColor<<green>> #27AE60
hide <<green>> stereotype
' Grey
skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype

' == CONTENT ==

legend top
    __Colors legend__ :
    * __External public API references__ :
    ** <back:yellow>**calypsonet-terminal-reader-java-api**</back>
end legend

package "org.calypsonet.terminal.calypso" as api {

    +class "**final** CalypsoApiProperties" as ApiProperties {
        +{static} **final** String VERSION
    }
    +enum WriteAccessLevel {
        PERSONALIZATION
        LOAD
        DEBIT
    }
    +enum SelectFileControl {
        FIRST_EF
        NEXT_EF
        CURRENT_DF
    }
    +enum GetDataTag {
        FCP_FOR_CURRENT_FILE
        FCI_FOR_CURRENT_DF
        EF_LIST
        TRACEABILITY_INFORMATION
    }
    package card {
        +interface "<<<back:yellow>CardSelection</back>>>\nCalypsoCardSelection" as CalypsoCardSelection {
            +CalypsoCardSelection filterByCardProtocol (String cardProtocol)

            +CalypsoCardSelection filterByPowerOnData (String powerOnDataRegex)

            +CalypsoCardSelection filterByDfName (byte[] aid)
            +CalypsoCardSelection filterByDfName (String aid)
            +CalypsoCardSelection setFileOccurrence (FileOccurrence fileOccurrence)
            +CalypsoCardSelection setFileControlInformation (FileControlInformation fileControlInformation)

            +CalypsoCardSelection acceptInvalidatedCard ()

            +CalypsoCardSelection prepareSelectFile (short lid)
            +CalypsoCardSelection prepareSelectFile (SelectFileControl selectControl)

            +CalypsoCardSelection prepareGetData (GetDataTag tag)

            +CalypsoCardSelection prepareReadRecord (byte sfi, int recordNumber)
        }
        +enum FileOccurrence {
            FIRST
            LAST
            NEXT
            PREVIOUS
        }
        +enum FileControlInformation {
            FCI
            NO_RESPONSE
        }
        +interface "<<<back:yellow>SmartCard</back>>>\nCalypsoCard" as CalypsoCard {
            +ProductType getProductType ()
            +boolean isHce ()

            +boolean isDfInvalidated ()

            +byte[] getDfName ()
            +byte[] getApplicationSerialNumber ()

            +byte[] getStartupInfoRawData ()
            +byte getPlatform ()
            +byte getApplicationType ()
            +byte getApplicationSubtype ()
            +byte getSoftwareIssuer ()
            +byte getSoftwareVersion ()
            +byte getSoftwareRevision ()
            +byte getSessionModification ()

            +byte[] getTraceabilityInformation ()

            +DirectoryHeader getDirectoryHeader ()
            +ElementaryFile getFileBySfi (byte sfi)
            +ElementaryFile getFileByLid (short lid)
            +Set<ElementaryFile> getFiles ()

            +boolean isDfRatified ()
            +int getTransactionCounter ()

            +boolean isPkiModeSupported ()
            +boolean isExtendedModeSupported ()
            +boolean isRatificationOnDeselectSupported ()

            +boolean isPinFeatureAvailable ()
            +boolean isPinBlocked ()
            +int getPinAttemptRemaining ()

            +boolean isSvFeatureAvailable ()
            +int getSvBalance ()
            +int getSvLastTNum ()
            +SvLoadLogRecord getSvLoadLogRecord ()
            +SvDebitLogRecord getSvDebitLogLastRecord ()
            +List<SvDebitLogRecord> getSvDebitLogAllRecords ()
        }
        +interface DirectoryHeader {
            +short getLid ()
            +Byte getDfStatus ()

            +byte[] getAccessConditions ()
            +byte[] getKeyIndexes ()

            +byte getKif (WriteAccessLevel writeAccessLevel)
            +byte getKvc (WriteAccessLevel writeAccessLevel)
        }
        +interface ElementaryFile {
            +byte getSfi ()
            +FileHeader getHeader ()
            +FileData getData ()
        }
        +interface FileHeader {
            +short getLid ()
            +byte getDfStatus ()
            +ElementaryFile.Type getEfType ()

            +int getRecordsNumber ()
            +int getRecordSize ()

            +byte[] getAccessConditions ()
            +byte[] getKeyIndexes ()

            +Short getSharedReference ()
        }
        +enum "Type" as FileType {
            LINEAR
            BINARY
            CYCLIC
            COUNTERS
            SIMULATED_COUNTERS
        }
        +interface FileData {
            +byte[] getContent ()
            +byte[] getContent (int numRecord)
            +byte[] getContent (int numRecord, int dataOffset, int dataLength)
            +SortedMap<Integer, byte[]> getAllRecordsContent ()

            +Integer getContentAsCounterValue (int numCounter)
            +SortedMap<Integer, Integer> getAllCountersValue ()
        }
        +enum "ProductType" as CardProductType {
            PRIME_REVISION_1
            PRIME_REVISION_2
            PRIME_REVISION_3
            LIGHT
            BASIC
            UNKNOWN
        }
        +interface SvLoadLogRecord {
            +byte[] getRawData ()

            +byte[] getLoadDate ()
            +byte[] getLoadTime ()

            +int getAmount ()
            +int getBalance ()
            +byte[] getFreeData ()

            +byte getKvc ()
            +byte[] getSamId ()
            +int getSamTNum ()
            +int getSvTNum ()
        }
        +interface SvDebitLogRecord {
            +byte[] getRawData ()

            +byte[] getDebitDate ()
            +byte[] getDebitTime ()

            +int getAmount ()
            +int getBalance ()

            +byte getKvc ()
            +byte[] getSamId ()
            +int getSamTNum ()
            +int getSvTNum ()
        }
    }
    package transaction {
        ' Card
        +interface CardTransactionManager {
            +<back:yellow>CardReader</back> getCardReader ()
            +CalypsoCard getCalypsoCard ()
            +SecuritySetting getSecuritySetting ()
            +<T extends CardTransactionCryptoExtension> T getCryptoExtension (Class<T> cardTransactionCryptoExtensionClass)

            +List<byte[]> getTransactionAuditData ()

            +CardTransactionManager prepareActivateEncryption ()
            +CardTransactionManager prepareDeactivateEncryption ()

            +CardTransactionManager prepareSelectFile (short lid)
            +CardTransactionManager prepareSelectFile (SelectFileControl selectFileControl)

            +CardTransactionManager prepareGetData (GetDataTag tag)

            +CardTransactionManager prepareReadRecord (byte sfi, int recordNumber)
            +CardTransactionManager prepareReadRecords (byte sfi, int fromRecordNumber, int toRecordNumber, int recordSize)
            +CardTransactionManager prepareReadRecordsPartially (byte sfi, int fromRecordNumber, int toRecordNumber, int offset, int nbBytesToRead)
            +CardTransactionManager prepareReadBinary (byte sfi, int offset, int nbBytesToRead)
            +CardTransactionManager prepareReadCounter (byte sfi, int nbCountersToRead)

            +CardTransactionManager prepareSearchRecords (SearchCommandData data)

            +CardTransactionManager prepareCheckPinStatus ()

            +CardTransactionManager prepareAppendRecord (byte sfi, byte[] recordData)
            +CardTransactionManager prepareUpdateRecord (byte sfi, int recordNumber, byte[] recordData)
            +CardTransactionManager prepareWriteRecord (byte sfi, int recordNumber, byte[] recordData)

            +CardTransactionManager prepareUpdateBinary (byte sfi, int offset, byte[] data)
            +CardTransactionManager prepareWriteBinary (byte sfi, int offset, byte[] data)

            +CardTransactionManager prepareIncreaseCounter (byte sfi, int counterNumber, int incValue)
            +CardTransactionManager prepareIncreaseCounters (byte sfi, Map<Integer, Integer> counterNumberToIncValueMap)
            +CardTransactionManager prepareDecreaseCounter (byte sfi, int counterNumber, int decValue)
            +CardTransactionManager prepareDecreaseCounters (byte sfi, Map<Integer, Integer> counterNumberToDecValueMap)
            +CardTransactionManager prepareSetCounter (byte sfi, int counterNumber, int newValue)

            +CardTransactionManager prepareSvGet (SvOperation svOperation, SvAction svAction)
            +CardTransactionManager prepareSvReload (int amount, byte[] date, byte[] time, byte[] free)
            +CardTransactionManager prepareSvReload (int amount)
            +CardTransactionManager prepareSvDebit (int amount, byte[] date, byte[] time)
            +CardTransactionManager prepareSvDebit (int amount)
            +CardTransactionManager prepareSvReadAllLogs ()

            +CardTransactionManager prepareInvalidate ()
            +CardTransactionManager prepareRehabilitate ()

            +CardTransactionManager prepareReleaseCardChannel ()

            +CardTransactionManager processVerifyPin (byte[] pin)
            +CardTransactionManager processChangePin (byte[] newPin)

            +CardTransactionManager processChangeKey (int keyIndex, byte newKif, byte newKvc, byte issuerKif, byte issuerKvc)

            +CardTransactionManager processCommands ()
            +CardTransactionManager processOpening (WriteAccessLevel writeAccessLevel)
            +CardTransactionManager processClosing ()
            +CardTransactionManager processCancel ()
        }
        +enum SvOperation {
            RELOAD
            DEBIT
        }
        +enum SvAction {
            DO
            UNDO
        }
        +interface SecuritySetting<T extends SecuritySetting<T>> {
            +T enableMultipleSession ()
        }
        +interface AsymmetricCryptoSecuritySetting extends SecuritySetting {
            +AsymmetricCryptoSecuritySetting setCryptoTransactionManager (AsymmetricCryptoTransactionManagerFactory cryptoTransactionManagerFactory)

            +AsymmetricCryptoSecuritySetting setAuthorityPublicKey (byte[] publicKey)
            +AsymmetricCryptoSecuritySetting setAuthorityCertificate (X509Certificate certificate)
            +AsymmetricCryptoSecuritySetting enableUnsignedPublicKeyUsage ()
        }
        +interface SymmetricCryptoSecuritySetting extends SecuritySetting {
            +SymmetricCryptoSecuritySetting setCryptoTransactionManager (SymmetricCryptoTransactionManagerFactory cryptoTransactionManagerFactory)

            +SymmetricCryptoSecuritySetting enableEarlyMutualAuthentication ()
            +SymmetricCryptoSecuritySetting enableRatificationMechanism ()
            +SymmetricCryptoSecuritySetting enablePinPlainTransmission ()
            +SymmetricCryptoSecuritySetting enableSvLoadAndDebitLog ()
            +SymmetricCryptoSecuritySetting authorizeSvNegativeBalance ()
            +SymmetricCryptoSecuritySetting forceRegularMode ()

            +SymmetricCryptoSecuritySetting assignKif (WriteAccessLevel writeAccessLevel, byte kvc, byte kif)
            +SymmetricCryptoSecuritySetting assignDefaultKif (WriteAccessLevel writeAccessLevel, byte kif)
            +SymmetricCryptoSecuritySetting assignDefaultKvc (WriteAccessLevel writeAccessLevel, byte kvc)

            +SymmetricCryptoSecuritySetting addAuthorizedSessionKey (byte kif, byte kvc)
            +SymmetricCryptoSecuritySetting addAuthorizedSvKey (byte kif, byte kvc)

            +SymmetricCryptoSecuritySetting setPinVerificationCipheringKey (byte kif, byte kvc)
            +SymmetricCryptoSecuritySetting setPinModificationCipheringKey (byte kif, byte kvc)
        }
        +interface SearchCommandData {
            +SearchCommandData setSfi (byte sfi)
            +SearchCommandData startAtRecord (int recordNumber)
            +SearchCommandData setOffset (int offset)
            +SearchCommandData enableRepeatedOffset ()
            +SearchCommandData setSearchData (byte[] data)
            +SearchCommandData setMask (byte[] mask)
            +SearchCommandData fetchFirstMatchingResult ()

            +List<Integer> getMatchingRecordNumbers ()
        }
        ' Exceptions
        +class "<<RuntimeException>>" as RuntimeException {
            +**SessionBufferOverflowException**: Session buffer would overflow for atomic session.
            +**UnauthorizedKeyException**
            +**CardRevokedException**
            +**InconsistentDataException**: Number of R-APDUs != number of C-APDUs **or** data read in session != data read outside session.
            +**InvalidSignatureException**: R-APDU of PSO Verify Signature = 6988.
            +**InvalidCardSignatureException**: R-APDU of DigestAuthenticate = 6988 **or** R-APDU of SvCheck = 6988.
            +**CardSignatureNotVerifiableException**: R-APDU of CloseSecureSession = 9000 but crypto resource is no more available.
            +**SelectFileException**: R-APDU of SelectFile = 6A82.
            +**UnexpectedCommandStatusException**
            +**ReaderIOException**: Card reader and/or Crypto reader communication is broken.
            +**CardIOException**
            +**CryptoIOException**
        }
        package spi {
            +interface AsymmetricCryptoTransactionManagerFactory {
            }
            +interface SymmetricCryptoTransactionManagerFactory {
            }
            +interface CardTransactionCryptoExtension {
            }
        }
    }
}

' Associations

CalypsoCardSelection +-- FileOccurrence
CalypsoCardSelection ..> FileOccurrence #C_LINK : provide >
CalypsoCardSelection +-- FileControlInformation
CalypsoCardSelection ..> FileControlInformation #C_LINK : provide >

CardTransactionManager ..> WriteAccessLevel #C_USE : use >
CardTransactionManager ..> SvOperation #C_USE : use >
CardTransactionManager ..> SvAction #C_USE : use >
CardTransactionManager .up.> SelectFileControl #C_USE : use >
CardTransactionManager .up.> GetDataTag #C_USE : use >
CardTransactionManager .up.> SearchCommandData #C_USE : use >
CardTransactionManager .right.> CalypsoCard #C_LINK : use and provide up to date content >
CardTransactionManager ..> SecuritySetting #C_LINK : provide >
CardTransactionManager ..> CardTransactionCryptoExtension #C_LINK : provide >

AsymmetricCryptoSecuritySetting ..> AsymmetricCryptoTransactionManagerFactory #C_USE : use >

SymmetricCryptoSecuritySetting ..> WriteAccessLevel #C_USE : use >
SymmetricCryptoSecuritySetting ..> SymmetricCryptoTransactionManagerFactory #C_USE : use >

CalypsoCardSelection .up.> SelectFileControl #C_USE : use >
CalypsoCardSelection .up.> GetDataTag #C_USE : use >

CalypsoCard ..> DirectoryHeader #C_LINK : provide >
CalypsoCard ..> ElementaryFile #C_LINK : provide >
CalypsoCard +-- CardProductType
CalypsoCard ..> CardProductType #C_LINK : provide >
CalypsoCard ..> SvLoadLogRecord #C_LINK : provide >
CalypsoCard ..> SvDebitLogRecord #C_LINK : provide >

DirectoryHeader ..> WriteAccessLevel #C_USE : use >

ElementaryFile +-- FileType
ElementaryFile ..> FileHeader #C_LINK : provide >
ElementaryFile ..> FileData #C_LINK : provide >

FileHeader .right.> FileType #C_LINK : provide >

' == LAYOUT ==

'SecuritySetting -[hidden]- CalypsoSam

' == STYLE ==

package api #C_GREY1 {}
package spi #C_GREY3 {}
package card #C_GREY2 {}
package transaction #C_GREY2 {}


@enduml